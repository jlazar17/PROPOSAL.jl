cmake_minimum_required(VERSION 3.15)
project(PROPOSAL_jl LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Find JlCxx (CxxWrap C++ library)
find_package(JlCxx REQUIRED)

# Find PROPOSAL - either installed or from source
if(DEFINED PROPOSAL_SOURCE_DIR)
    message(STATUS "Building PROPOSAL from source: ${PROPOSAL_SOURCE_DIR}")

    # Add PROPOSAL as a subdirectory
    set(BUILD_PYTHON OFF CACHE BOOL "" FORCE)
    set(BUILD_TESTING OFF CACHE BOOL "" FORCE)
    add_subdirectory(${PROPOSAL_SOURCE_DIR} proposal_build EXCLUDE_FROM_ALL)

    # Set include directories
    set(PROPOSAL_INCLUDE_DIRS
        ${PROPOSAL_SOURCE_DIR}/src/PROPOSAL
    )
else()
    # Find installed PROPOSAL
    find_package(PROPOSAL REQUIRED)
    get_target_property(PROPOSAL_INCLUDE_DIRS PROPOSAL::PROPOSAL INTERFACE_INCLUDE_DIRECTORIES)
endif()

# Collect wrapper source files
# These are generated by WrapIt in the jl/ subdirectory
file(GLOB WRAPPER_SOURCES
    "${CMAKE_CURRENT_SOURCE_DIR}/jl/*.cxx"
    "${CMAKE_CURRENT_SOURCE_DIR}/jl/*.cpp"
)

# If no generated sources exist yet, create a placeholder
if(NOT WRAPPER_SOURCES)
    message(STATUS "No generated wrapper sources found. Creating placeholder module.")

    # Create a minimal wrapper that can be built for testing
    set(PLACEHOLDER_SOURCE "${CMAKE_CURRENT_BINARY_DIR}/placeholder.cxx")
    file(WRITE ${PLACEHOLDER_SOURCE} "
#include \"jlcxx/jlcxx.hpp\"

JLCXX_MODULE define_julia_module(jlcxx::Module& mod) {
    // Placeholder - run WrapIt to generate actual bindings
    mod.method(\"placeholder\", []() { return \"PROPOSAL.jl placeholder - run WrapIt to generate bindings\"; });
}
")
    set(WRAPPER_SOURCES ${PLACEHOLDER_SOURCE})
endif()

# Create the wrapper library
add_library(PROPOSAL_jl SHARED ${WRAPPER_SOURCES})

target_include_directories(PROPOSAL_jl PRIVATE
    ${PROPOSAL_INCLUDE_DIRS}
    ${CMAKE_CURRENT_SOURCE_DIR}/jl
)

target_link_libraries(PROPOSAL_jl
    PRIVATE
    JlCxx::cxxwrap_julia
)

# Link to PROPOSAL
if(TARGET PROPOSAL)
    target_link_libraries(PROPOSAL_jl PRIVATE PROPOSAL)
elseif(TARGET PROPOSAL::PROPOSAL)
    target_link_libraries(PROPOSAL_jl PRIVATE PROPOSAL::PROPOSAL)
endif()

# Set output directory
set_target_properties(PROPOSAL_jl PROPERTIES
    LIBRARY_OUTPUT_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/../build/lib"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/../build/lib"
)

# Install rules
install(TARGETS PROPOSAL_jl
    LIBRARY DESTINATION lib
    RUNTIME DESTINATION lib
)
